<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Scanner & Gen</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; background: #000; color: #fff; text-align: center; }
        .screen { display: none; padding: 20px; flex-direction: column; align-items: center; min-height: 100vh; box-sizing: border-box; }
        .active { display: flex; }
        
        /* --- ä¿®æ­£ç‚¹1 & 2: ã‚«ãƒ¡ãƒ©æ˜ åƒã®è¡¨ç¤ºè¨­å®š --- */
        #video-container { 
            position: relative; 
            width: 100%; /* å¹…ã„ã£ã±ã„ã« */
            max-width: 600px; /* æœ€å¤§å¹…ã‚’è¨­å®š */
            overflow: hidden; 
            background: #222; 
            border-radius: 10px;
            margin-bottom: 20px;
        }
        video { 
            width: 100%;
            height: auto; /* é«˜ã•ã¯è‡ªå‹•èª¿æ•´ */
            display: block;
            /* transform: scaleX(-1);  <-- å·¦å³åè»¢ã‚’å‰Šé™¤ */
        }
        /* --------------------------------------- */
        
        /* èª­ã¿å–ã‚Šçµæœç”»é¢ */
        #result-area { width: 90%; max-width: 600px; margin-top: 20px; }
        textarea { width: 100%; height: 120px; font-size: 16px; padding: 10px; border-radius: 5px; box-sizing: border-box; color: #000; }
        
        /* ãƒœã‚¿ãƒ³é¡ */
        button { 
            width: 100%; max-width: 600px; padding: 15px; margin: 10px 0; font-size: 18px; font-weight: bold;
            border: none; border-radius: 8px; cursor: pointer;
        }
        .btn-blue { background: #007bff; color: white; }
        .btn-green { background: #28a745; color: white; }
        .btn-gray { background: #555; color: white; }
        
        /* ä¿®æ­£ç‚¹3: URLã‚’é–‹ããƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #open-url-btn { display: none; } /* åˆæœŸçŠ¶æ…‹ã¯éè¡¨ç¤º */

        /* QRã‚³ãƒ¼ãƒ‰è¡¨ç¤ºã‚¨ãƒªã‚¢ */
        #qrcode-output { margin-top: 20px; padding: 20px; background: white; border-radius: 10px; display: inline-block; }
    </style>
</head>
<body>

    <div id="scanner-screen" class="screen active">
        <h2>[ QR Scanner ]</h2>
        <div id="video-container">
            <video id="video" autoplay playsinline></video>
            <canvas id="canvas" hidden></canvas>
        </div>
        <p>QRã‚³ãƒ¼ãƒ‰ã‚’ã‚«ãƒ¡ãƒ©ã«å†™ã—ã¦ãã ã•ã„</p>
        <button class="btn-blue" onclick="switchScreen('generator-screen')">QRã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆã™ã‚‹</button>
    </div>

    <div id="result-screen" class="screen">
        <h2>[ Scan Result ]</h2>
        <div id="result-area">
            <textarea id="result-text" readonly></textarea>
            
            <button id="open-url-btn" class="btn-blue" onclick="openURL()">ğŸ”— URLã‚’é–‹ã</button>
            <button class="btn-green" onclick="copyResult()">çµæœã‚’ã‚³ãƒ”ãƒ¼</button>
            <button class="btn-gray" onclick="restartScanner()">ã‚‚ã†ä¸€åº¦ã‚¹ã‚­ãƒ£ãƒ³</button>
        </div>
    </div>

    <div id="generator-screen" class="screen">
        <h2>[ QR Generator ]</h2>
        <input type="text" id="qr-input" value="https://" style="width: 90%; max-width: 600px; padding: 15px; font-size: 16px; margin-bottom: 10px; box-sizing: border-box;">
        <button class="btn-blue" onclick="generateQR()">QRã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ</button>
        <div id="qrcode-output"></div>
        <button class="btn-gray" onclick="switchScreen('scanner-screen')" style="margin-top: 30px;">ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ã«æˆ»ã‚‹</button>
    </div>

    <script>
        // Service Workerã®ç™»éŒ² (ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œ)
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(() => console.log('Service Worker Registered'))
                .catch((err) => console.log('SW registration failed', err));
        }

        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas').getContext('2d');
        const resultText = document.getElementById('result-text');
        const openUrlBtn = document.getElementById('open-url-btn'); // URLãƒœã‚¿ãƒ³ã‚’å–å¾—
        let stream = null;
        let isScanning = false;

        // ã‚«ãƒ¡ãƒ©é–‹å§‹
        async function startCamera() {
            try {
                // èƒŒé¢ã‚«ãƒ¡ãƒ©ã‚’å„ªå…ˆçš„ã«ä½¿ç”¨
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    isScanning = true;
                    requestAnimationFrame(tick);
                };
            } catch (err) {
                alert("ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚");
                console.error(err);
            }
        }

        // ã‚¹ã‚­ãƒ£ãƒ³ãƒ«ãƒ¼ãƒ—
        function tick() {
            if (!isScanning) return;
            
            if (video.readyState === video.HAVE_ENOUGH_DATA && document.getElementById('scanner-screen').classList.contains('active')) {
                const cvs = document.getElementById('canvas');
                cvs.height = video.videoHeight;
                cvs.width = video.videoWidth;
                canvas.drawImage(video, 0, 0, cvs.width, cvs.height);
                const imageData = canvas.getImageData(0, 0, cvs.width, cvs.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "dontInvert",
                });

                if (code) {
                    showResult(code.data);
                    return; // ã‚¹ã‚­ãƒ£ãƒ³æˆåŠŸã—ãŸã‚‰ãƒ«ãƒ¼ãƒ—ã‚’æ­¢ã‚ã‚‹
                }
            }
            requestAnimationFrame(tick);
        }

        function showResult(data) {
            isScanning = false; // ã‚¹ã‚­ãƒ£ãƒ³åœæ­¢
            resultText.value = data;
            
            // --- ä¿®æ­£ç‚¹3: URLã‹ã©ã†ã‹ã®åˆ¤å®šã¨ãƒœã‚¿ãƒ³è¡¨ç¤º ---
            if (data.startsWith('http://') || data.startsWith('https://')) {
                openUrlBtn.style.display = 'block'; // URLãªã‚‰ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            } else {
                openUrlBtn.style.display = 'none';  // URLã§ãªã‘ã‚Œã°éè¡¨ç¤º
            }
            // ---------------------------------------
            
            switchScreen('result-screen');
        }

        // URLã‚’é–‹ãé–¢æ•°
        function openURL() {
            const url = resultText.value;
            if (url) {
                window.open(url, '_blank'); // æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã
            }
        }

        function restartScanner() {
            resultText.value = "";
            openUrlBtn.style.display = 'none';
            switchScreen('scanner-screen');
            isScanning = true;
            requestAnimationFrame(tick); // ã‚¹ã‚­ãƒ£ãƒ³å†é–‹
        }

        function switchScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            
            // ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ç”»é¢ã‹ã‚‰é›¢ã‚Œã‚‹ã¨ãã¯ã‚¹ã‚­ãƒ£ãƒ³ã‚’åœæ­¢
            if (screenId !== 'scanner-screen') {
                isScanning = false;
            } else {
                 // ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ç”»é¢ã«æˆ»ã‚‹ã¨ãã¯ã€ã‚«ãƒ¡ãƒ©ãŒæº–å‚™ã§ãã¦ã„ã‚Œã°å†é–‹
                 if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    isScanning = true;
                    requestAnimationFrame(tick);
                 }
            }
        }

        function copyResult() {
            resultText.select();
            // ãƒ¢ãƒã‚¤ãƒ«ç«¯æœ«ã§ã®ã‚³ãƒ”ãƒ¼å¯¾å¿œ
            resultText.setSelectionRange(0, 99999); 

            try {
                // æ–°ã—ã„Clipboard APIã‚’è©¦ã™
                navigator.clipboard.writeText(resultText.value).then(() => {
                    alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼");
                }).catch(err => {
                    // å¤±æ•—ã—ãŸã‚‰å¤ã„æ–¹æ³•ã§è©¦ã™
                    console.error('Clipboard API failed, trying execCommand', err);
                    fallbackCopyTextToClipboard(resultText.value);
                });
            } catch (err) {
                 fallbackCopyTextToClipboard(resultText.value);
            }
        }
        
        function fallbackCopyTextToClipboard(text) {
            document.execCommand('copy');
            alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼ï¼ˆãŸã¶ã‚“ï¼‰");
        }

        function generateQR() {
            const output = document.getElementById('qrcode-output');
            output.innerHTML = ""; // å‰ã®QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªã‚¢
            const text = document.getElementById('qr-input').value;
            if (!text) return;

            new QRCode(output, {
                text: text,
                width: 200,
                height: 200,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ã‚«ãƒ¡ãƒ©ã‚’é–‹å§‹
        window.onload = startCamera;
    </script>
</body>
</html>
