<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/svg+xml" href="./icon.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Scanner & Gen (Pro)</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; background: #000; color: #fff; text-align: center; }
        .screen { display: none; padding: 20px; flex-direction: column; align-items: center; min-height: 100vh; box-sizing: border-box; }
        .active { display: flex; }
        
        /* ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #install-area { width: 100%; display: none; margin-bottom: 10px; }
        #install-button { width: 100%; padding: 15px; background: #ff9800; color: white; border: none; border-radius: 8px; font-weight: bold; }

        #video-container { 
            position: relative; width: 100%; max-width: 600px; 
            overflow: hidden; background: #222; border-radius: 10px; margin-bottom: 20px;
        }
        video { width: 100%; height: auto; display: block; }
        #result-area { width: 90%; max-width: 600px; }
        textarea { width: 100%; height: 120px; font-size: 16px; padding: 10px; border-radius: 5px; box-sizing: border-box; }
        
        button { width: 100%; max-width: 600px; padding: 15px; margin: 10px 0; font-size: 18px; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; }
        .btn-blue { background: #007bff; color: white; }
        .btn-green { background: #28a745; color: white; }
        .btn-gray { background: #555; color: white; }
        #open-url-btn { display: none; }
        #qrcode-output { margin-top: 20px; padding: 20px; background: white; border-radius: 10px; display: inline-block; }
    </style>
</head>
<body>

    <div id="scanner-screen" class="screen active">
        <div id="install-area">
            <button id="install-button">ğŸ“² ã‚¢ãƒ—ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹</button>
        </div>

        <h2>[ QR Scanner ]</h2>
        <div id="video-container">
            <video id="video" autoplay playsinline></video>
            <canvas id="canvas" hidden></canvas>
        </div>
        <p>QRã‚³ãƒ¼ãƒ‰ã‚’ã‚«ãƒ¡ãƒ©ã«å†™ã—ã¦ãã ã•ã„</p>
        <button class="btn-blue" onclick="switchScreen('generator-screen')">QRã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆã™ã‚‹</button>
    </div>

    <div id="result-screen" class="screen">
        <h2>[ Scan Result ]</h2>
        <div id="result-area">
            <textarea id="result-text" readonly></textarea>
            <button id="open-url-btn" class="btn-blue" onclick="openURL()">ğŸ”— URLã‚’é–‹ã</button>
            <button class="btn-green" onclick="copyResult()">çµæœã‚’ã‚³ãƒ”ãƒ¼</button>
            <button class="btn-gray" onclick="restartScanner()">ã‚‚ã†ä¸€åº¦ã‚¹ã‚­ãƒ£ãƒ³</button>
        </div>
    </div>

    <div id="generator-screen" class="screen">
        <h2>[ QR Generator ]</h2>
        <input type="text" id="qr-input" value="https://" style="width: 90%; max-width: 600px; padding: 15px; font-size: 16px; margin-bottom: 10px; box-sizing: border-box;">
        <button class="btn-blue" onclick="generateQR()">QRã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ</button>
        <div id="qrcode-output"></div>
        <button class="btn-gray" onclick="switchScreen('scanner-screen')" style="margin-top: 30px;">ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ã«æˆ»ã‚‹</button>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvasElement = document.getElementById('canvas');
        const canvas = canvasElement.getContext('2d', { willReadFrequently: true });
        const resultText = document.getElementById('result-text');
        const openUrlBtn = document.getElementById('open-url-btn');
        let isScanning = false;

        // --- PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«è¨­å®š ---
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('install-area').style.display = 'block';
        });

        document.getElementById('install-button').addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    document.getElementById('install-area').style.display = 'none';
                }
                deferredPrompt = null;
            }
        });

        // --- ã‚«ãƒ¡ãƒ©åˆ¶å¾¡ (ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆå¯¾ç­–ç‰ˆ) ---
        async function startCamera() {
            const constraints = {
                video: {
                    facingMode: 'environment',
                    // è§£åƒåº¦ã‚’ã‚ã‚‹ç¨‹åº¦å›ºå®šã™ã‚‹ã“ã¨ã§ã€ãƒãƒƒãƒ•ã‚¡ã®ã‚ºãƒ¬ã‚’é˜²ã
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            };

            try {
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                
                // æ˜ åƒãŒå®Ÿéš›ã«å†ç”Ÿã•ã‚Œã‚‹ã¾ã§å¾…æ©Ÿ
                video.onloadedmetadata = () => {
                    video.play();
                    isScanning = true;
                    requestAnimationFrame(tick);
                };
            } catch (err) {
                alert("ã‚«ãƒ¡ãƒ©ã®æ¥ç¶šã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚");
            }
        }

        function tick() {
            if (!isScanning) return;

            // æ˜ åƒãŒæº–å‚™ã§ãã¦ã„ã¦ã€ã‹ã¤ãƒã‚¤ã‚ºã‚’é˜²ããŸã‚ã«ã‚µã‚¤ã‚ºãŒç¢ºå®šã—ã¦ã„ã‚‹ã‹ç¢ºèª
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã‚µã‚¤ã‚ºã‚’ãƒ“ãƒ‡ã‚ªã®è§£åƒåº¦ã«åˆã‚ã›ã‚‹
                if (canvasElement.width !== video.videoWidth) {
                    canvasElement.width = video.videoWidth;
                    canvasElement.height = video.videoHeight;
                }

                canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
                const imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
                
                const code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "dontInvert",
                });

                if (code) {
                    showResult(code.data);
                    return;
                }
            }
            requestAnimationFrame(tick);
        }

        // --- ä»¥ä¸‹ã€ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£æ©Ÿèƒ½ ---
        function showResult(data) {
            isScanning = false;
            resultText.value = data;
            openUrlBtn.style.display = (data.startsWith('http')) ? 'block' : 'none';
            switchScreen('result-screen');
        }

        function restartScanner() {
            switchScreen('scanner-screen');
            isScanning = true;
            requestAnimationFrame(tick);
        }

        function switchScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            isScanning = (screenId === 'scanner-screen');
        }

        function openURL() { window.open(resultText.value, '_blank'); }

        function copyResult() {
            navigator.clipboard.writeText(resultText.value);
            alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
        }

        function generateQR() {
            const output = document.getElementById('qrcode-output');
            output.innerHTML = "";
            new QRCode(output, { text: document.getElementById('qr-input').value, width: 200, height: 200 });
        }

        window.onload = startCamera;
        if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js'); }
    </script>
</body>
</html>
