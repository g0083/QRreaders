<!DOCTYPE html>
<html lang="ja">
<head>
    <link rel="manifest" href="manifest.json">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Scanner & Gen</title>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; background: #000; color: #fff; text-align: center; }
        .screen { display: none; padding: 20px; flex-direction: column; align-items: center; min-height: 100vh; }
        .active { display: flex; }
        
        /* カメラ映像の設定 */
        #video-container { position: relative; width: 90%; max-width: 500px; aspect-ratio: 3/4; overflow: hidden; background: #222; border-radius: 10px; }
        video { 
            position: absolute; width: 100%; height: 100%; object-fit: cover;
            /* 右90度回転 & 左右反転 (鏡像) */
            transform: scaleX(-1); 
        }
        
        /* 読み取り結果画面 */
        #result-area { width: 90%; margin-top: 20px; }
        textarea { width: 100%; height: 150px; font-size: 16px; padding: 10px; border-radius: 5px; }
        
        /* ボタン類 */
        button { 
            width: 90%; padding: 15px; margin: 10px 0; font-size: 18px; font-weight: bold;
            border: none; border-radius: 8px; cursor: pointer;
        }
        .btn-blue { background: #007bff; color: white; }
        .btn-green { background: #28a745; color: white; }
        .btn-gray { background: #555; color: white; }

        /* QRコード表示エリア */
        #qrcode-output { margin-top: 20px; padding: 10px; background: white; border-radius: 10px; }
    </style>
</head>
<body>

    <div id="scanner-screen" class="screen active">
        <h2>[ QR Scanner ]</h2>
        <div id="video-container">
            <video id="video" autoplay playsinline></video>
            <canvas id="canvas" hidden></canvas>
        </div>
        <p>QRコードを枠内に写してください</p>
        <button class="btn-blue" onclick="switchScreen('generator-screen')">QRコードを作成する</button>
    </div>

    <div id="result-screen" class="screen">
        <h2>[ Scan Result ]</h2>
        <div id="result-area">
            <textarea id="result-text" readonly></textarea>
            <button class="btn-green" onclick="copyResult()">結果をコピー</button>
            <button class="btn-gray" onclick="restartScanner()">もう一度スキャン</button>
        </div>
    </div>

    <div id="generator-screen" class="screen">
        <h2>[ QR Generator ]</h2>
        <input type="text" id="qr-input" value="https://" style="width: 90%; padding: 15px; font-size: 16px; margin-bottom: 10px;">
        <button class="btn-blue" onclick="generateQR()">QRコードを生成</button>
        <div id="qrcode-output"></div>
        <button class="btn-gray" onclick="switchScreen('scanner-screen')" style="margin-top: 30px;">スキャナーに戻る</button>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas').getContext('2d');
        const resultText = document.getElementById('result-text');
        let stream = null;

        // カメラ開始
        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                video.srcObject = stream;
                requestAnimationFrame(tick);
            } catch (err) {
                alert("カメラの起動に失敗しました: " + err);
            }
        }

        // スキャンループ
        function tick() {
            if (video.readyState === video.HAVE_ENOUGH_DATA && document.getElementById('scanner-screen').classList.contains('active')) {
                const cvs = document.getElementById('canvas');
                cvs.height = video.videoHeight;
                cvs.width = video.videoWidth;
                canvas.drawImage(video, 0, 0, cvs.width, cvs.height);
                const imageData = canvas.getImageData(0, 0, cvs.width, cvs.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);

                if (code) {
                    showResult(code.data);
                    return;
                }
            }
            requestAnimationFrame(tick);
        }

        function showResult(data) {
            resultText.value = data;
            switchScreen('result-screen');
        }

        function restartScanner() {
            switchScreen('scanner-screen');
        }

        function switchScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            if(screenId === 'scanner-screen') tick();
        }

        function copyResult() {
            resultText.select();
            document.execCommand('copy');
            alert("コピーしました！");
        }

        function generateQR() {
            const output = document.getElementById('qrcode-output');
            output.innerHTML = "";
            new QRCode(output, {
                text: document.getElementById('qr-input').value,
                width: 200, height: 200
            });
        }

        window.onload = startCamera;
        
        // サービスワーカーの登録
        if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js')
            .then(() => console.log('Offline mode ready'))
            .catch((err) => console.log('SW registration failed', err));
    }
    
    

    </script>
</body>
</html>
